<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e40af">
    <meta name="description" content="Real-time commuter assistant for Philippine provincial routes">
    <title>SakayAgent - Smart Commute Assistant</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2FrYXlBZ2VudCIsInNob3J0X25hbWUiOiJTYWtheUFnZW50IiwidGhlbWVfY29sb3IiOiIjMWU0MGFmIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii8ifQ==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1f2937;
            overflow-x: hidden;
        }

        #app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .logo-text h1 {
            font-size: 24px;
            color: #1e40af;
            margin-bottom: 2px;
        }

        .logo-text p {
            font-size: 12px;
            color: #6b7280;
        }

        .status-badge {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .weather-widget {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #e5e7eb;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .weather-icon {
            font-size: 32px;
        }

        .fare-calculator {
            background: #fef3c7;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .quick-tips {
            background: #dbeafe;
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            margin-top: 15px;
        }

        .passenger-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .counter-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #667eea;
            background: white;
            border-radius: 8px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .counter-btn:hover {
            background: #667eea;
            color: white;
        }

        .counter-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e40af;
            min-width: 40px;
            text-align: center;
        }

        .nearby-places {
            margin-top: 15px;
        }

        .place-chip {
            display: inline-block;
            background: white;
            border: 2px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 20px;
            margin: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .place-chip:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .eta-display {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
        }

        .eta-time {
            font-size: 32px;
            font-weight: 700;
            margin: 5px 0;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .notification-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 999;
            animation: slideIn 0.3s ease;
        }

        .notification-badge.show {
            display: flex;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .bookmark-btn {
            background: #fbbf24;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .bookmark-btn:hover {
            transform: scale(1.1);
        }

        .saved-routes {
            margin-top: 15px;
        }

        .saved-route-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-route-item:hover {
            background: #f0f4ff;
            transform: translateX(5px);
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* 3D Map Container */
        .map-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .map-header h2 {
            font-size: 20px;
            color: #1e40af;
        }

        .view-controls {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        #map-canvas {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            display: block;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 16px;
            color: #1e40af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #1f2937;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Agent System */
        .agent-system {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .agent-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-name {
            font-weight: 600;
            color: #1e40af;
            font-size: 14px;
        }

        .agent-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .agent-status.active {
            background: #d1fae5;
            color: #059669;
        }

        .agent-status.processing {
            background: #fef3c7;
            color: #d97706;
        }

        .agent-content {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.5;
        }

        /* Traffic Info */
        .traffic-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .traffic-level {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .traffic-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .traffic-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
            transition: width 1s ease;
        }

        /* Route Options */
        .route-options {
            display: grid;
            gap: 12px;
            margin-top: 15px;
        }

        .route-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .route-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .route-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .route-type {
            font-weight: 600;
            color: #1e40af;
        }

        .route-time {
            color: #059669;
            font-weight: 600;
        }

        .route-details {
            font-size: 13px;
            color: #6b7280;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            #map-canvas {
                height: 400px;
            }
        }

        @media (max-width: 640px) {
            #app-container {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .logo-text h1 {
                font-size: 20px;
            }

            #map-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">üöç</div>
                <div class="logo-text">
                    <h1>SakayAgent</h1>
                    <p>Multi-Agent Commuter Assistant</p>
                </div>
            </div>
            <div class="status-badge">
                <span class="pulse"></span>
                <span>All Systems Active</span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- 3D Map -->
            <div class="map-container">
                <div class="map-header">
                    <h2>üìç Real-time Route Visualization</h2>
                    <div class="view-controls">
                        <button class="view-btn active" onclick="changeView('top')">Top</button>
                        <button class="view-btn" onclick="changeView('angle')">3D</button>
                        <button class="view-btn" onclick="changeView('follow')">Follow</button>
                    </div>
                </div>
                <canvas id="map-canvas"></canvas>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-section">
                    <h3>üéØ Plan Your Trip</h3>
                    <div class="input-group">
                        <label>From (Kasalukuyan)</label>
                        <input type="text" id="from-input" placeholder="e.g., Cabanatuan Terminal" value="Cabanatuan Terminal">
                    </div>
                    <div class="input-group">
                        <label>To (Pupuntahan)</label>
                        <input type="text" id="to-input" placeholder="e.g., Bongabon Market" value="Bongabon Market">
                    </div>
                    <div class="input-group">
                        <label>Vehicle Type</label>
                        <select id="vehicle-select">
                            <option value="jeep">Jeepney</option>
                            <option value="tricycle">Tricycle</option>
                            <option value="uv">UV Express</option>
                            <option value="bus">Bus</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="findRoute()">
                        üîç Find Best Route
                    </button>
                </div>

                <div class="control-section">
                    <h3>ü§ñ Agent System Status</h3>
                    <div class="agent-system" id="agent-system">
                        <div class="agent-card">
                            <div class="agent-header">
                                <span class="agent-name">üß† Traffic Prediction Agent</span>
                                <span class="agent-status active">Ready</span>
                            </div>
                            <div class="agent-content">
                                ML model analyzing historical patterns and current conditions
                            </div>
                        </div>
                        <div class="agent-card">
                            <div class="agent-header">
                                <span class="agent-name">üí¨ Tagalog Explainer Agent</span>
                                <span class="agent-status active">Ready</span>
                            </div>
                            <div class="agent-content">
                                GenAI-powered natural language explanations
                            </div>
                        </div>
                        <div class="agent-card">
                            <div class="agent-header">
                                <span class="agent-name">üö¶ Route Optimizer Agent</span>
                                <span class="agent-status active">Ready</span>
                            </div>
                            <div class="agent-content">
                                Real-time rerouting using LTFRB data + Flink streams
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Traffic Info & Route Options -->
        <div class="main-grid">
            <div class="traffic-info">
                <h3 style="color: #1e40af; margin-bottom: 15px;">üö¶ Current Traffic Conditions</h3>
                <div id="traffic-status">
                    <p style="color: #6b7280; margin-bottom: 10px;">Traffic Level: <strong id="traffic-level-text">Moderate</strong></p>
                    <div class="traffic-level">
                        <div class="traffic-bar">
                            <div class="traffic-bar-fill" id="traffic-bar-fill" style="width: 45%"></div>
                        </div>
                    </div>
                    <p style="color: #6b7280; margin-top: 15px; font-size: 14px;" id="traffic-explanation">
                        <strong>Paliwanag:</strong> Katamtaman ang daloy ng trapiko sa rutang ito. May ilang bottleneck sa may palengke pero generally smooth ang travel.
                    </p>
                </div>
                
                <h3 style="color: #1e40af; margin: 20px 0 15px;">üõ£Ô∏è Available Routes</h3>
                <div class="route-options" id="route-options">
                    <!-- Routes will be populated here -->
                </div>
            </div>

            <div class="control-panel">
                <div class="control-section">
                    <h3>üí∞ Booking & Payment</h3>
                    <div id="booking-section" style="opacity: 0.5; pointer-events: none;">
                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 15px;">
                            Select a route to enable booking
                        </p>
                        <button class="btn btn-primary" onclick="bookTrip()" style="margin-bottom: 10px;">
                            üé´ Book UV Express
                        </button>
                        <button class="btn btn-secondary" onclick="payGCash()">
                            üí≥ Pay with GCash
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üìö Learn Concepts</h3>
                    <div style="font-size: 13px; color: #4b5563; line-height: 1.6;">
                        <p style="margin-bottom: 10px;"><strong>Multi-Agent System:</strong> Different AI agents work together - traffic predictor, language explainer, and route optimizer</p>
                        <p style="margin-bottom: 10px;"><strong>Event Streaming (Flink):</strong> Real-time data processing from LTFRB open data feeds</p>
                        <p style="margin-bottom: 10px;"><strong>GenAI Integration:</strong> Natural language explanations in Tagalog for better accessibility</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 style="color: #1e40af; margin-bottom: 10px;">Processing...</h3>
            <p style="color: #6b7280; font-size: 14px;" id="loading-text">Analyzing routes...</p>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============================================
        // THREE.JS 3D MAP VISUALIZATION
        // ============================================
        
        let scene, camera, renderer, mapObjects = {};
        let vehicles = [];
        let routes = [];
        let animationId;
        let currentView = 'top';

        function initThreeJS() {
            const canvas = document.getElementById('map-canvas');
            const container = canvas.parentElement;

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f9ff);
            scene.fog = new THREE.Fog(0xf0f9ff, 50, 200);

            // Camera setup
            const aspect = canvas.clientWidth / canvas.clientHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
            camera.position.set(0, 50, 50);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(20, 40, 20);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Ground plane (road network)
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xe8f5e9,
                roughness: 0.8 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Create road network
            createRoadNetwork();

            // Create buildings
            createBuildings();

            // Create initial vehicles
            createVehicles();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation loop
            animate();
        }

        function createRoadNetwork() {
            const roadMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x424242,
                roughness: 0.9 
            });

            // Main roads
            const roads = [
                { x: 0, z: 0, width: 4, length: 80, rotation: 0 },
                { x: 0, z: 0, width: 4, length: 80, rotation: Math.PI / 2 },
                { x: 15, z: 0, width: 3, length: 60, rotation: 0 },
                { x: -15, z: 0, width: 3, length: 60, rotation: 0 },
                { x: 0, z: 15, width: 3, length: 60, rotation: Math.PI / 2 },
                { x: 0, z: -15, width: 3, length: 60, rotation: Math.PI / 2 }
            ];

            roads.forEach(road => {
                const geometry = new THREE.BoxGeometry(road.width, 0.1, road.length);
                const mesh = new THREE.Mesh(geometry, roadMaterial);
                mesh.position.set(road.x, 0.05, road.z);
                mesh.rotation.y = road.rotation;
                mesh.receiveShadow = true;
                scene.add(mesh);

                // Road markings
                const markingGeometry = new THREE.BoxGeometry(0.2, 0.15, road.length * 0.8);
                const markingMaterial = new THREE.MeshStandardMaterial({ color: 0xffeb3b });
                const marking = new THREE.Mesh(markingGeometry, markingMaterial);
                marking.position.set(road.x, 0.1, road.z);
                marking.rotation.y = road.rotation;
                scene.add(marking);
            });

            // Store road reference
            mapObjects.roads = roads;
        }

        function createBuildings() {
            const buildingPositions = [
                { x: -20, z: -20, w: 8, h: 12, d: 8 },
                { x: 20, z: -20, w: 10, h: 15, d: 10 },
                { x: -20, z: 20, w: 6, h: 10, d: 6 },
                { x: 20, z: 20, w: 12, h: 18, d: 12 },
                { x: -30, z: 0, w: 7, h: 8, d: 7 },
                { x: 30, z: 0, w: 9, h: 14, d: 9 }
            ];

            buildingPositions.forEach(pos => {
                const geometry = new THREE.BoxGeometry(pos.w, pos.h, pos.d);
                const material = new THREE.MeshStandardMaterial({ 
                    color: new THREE.Color().setHSL(Math.random() * 0.1 + 0.55, 0.3, 0.7),
                    roughness: 0.7 
                });
                const building = new THREE.Mesh(geometry, material);
                building.position.set(pos.x, pos.h / 2, pos.z);
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);

                // Building roof
                const roofGeometry = new THREE.BoxGeometry(pos.w + 0.5, 0.5, pos.d + 0.5);
                const roofMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xd32f2f,
                    roughness: 0.5 
                });
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.set(pos.x, pos.h + 0.25, pos.z);
                roof.castShadow = true;
                scene.add(roof);
            });
        }

        function createVehicles() {
            const vehicleTypes = [
                { color: 0xff6b6b, type: 'jeep' },
                { color: 0x4ecdc4, type: 'bus' },
                { color: 0xffe66d, type: 'tricycle' },
                { color: 0x95e1d3, type: 'uv' }
            ];

            vehicleTypes.forEach((vType, i) => {
                const vehicle = createVehicle(vType.color, vType.type);
                vehicle.position.set(-30 + i * 15, 0.5, -30);
                vehicle.userData.speed = 0.1 + Math.random() * 0.1;
                vehicle.userData.route = generateRoute();
                vehicle.userData.routeIndex = 0;
                vehicle.userData.type = vType.type;
                vehicles.push(vehicle);
                scene.add(vehicle);
            });
        }

        function createVehicle(color, type) {
            const group = new THREE.Group();

            // Vehicle body
            let bodyGeometry;
            if (type === 'jeep') {
                bodyGeometry = new THREE.BoxGeometry(2, 1.5, 4);
            } else if (type === 'bus') {
                bodyGeometry = new THREE.BoxGeometry(2.5, 2.5, 8);
            } else if (type === 'tricycle') {
                bodyGeometry = new THREE.BoxGeometry(1.5, 1, 2);
            } else {
                bodyGeometry = new THREE.BoxGeometry(2, 1.8, 5);
            }

            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: color,
                metalness: 0.3,
                roughness: 0.7
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.castShadow = true;
            group.add(body);

            // Wheels
            const wheelGeometry = new THREE.CylinderGeometry(0.4, 0.4, 0.3, 16);
            const wheelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x212121,
                roughness: 0.9 
            });

            const wheelPositions = type === 'tricycle' 
                ? [[-0.7, -0.5, 0.8], [0.7, -0.5, 0.8], [0, -0.5, -0.8]]
                : [[-1, -0.7, 1.5], [1, -0.7, 1.5], [-1, -0.7, -1.5], [1, -0.7, -1.5]];

            wheelPositions.forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.rotation.z = Math.PI / 2;
                wheel.position.set(pos[0], pos[1], pos[2]);
                group.add(wheel);
            });

            return group;
        }

        function generateRoute() {
            const route = [];
            const points = 8;
            for (let i = 0; i < points; i++) {
                route.push({
                    x: -35 + Math.random() * 70,
                    z: -35 + Math.random() * 70
                });
            }
            return route;
        }

        function updateVehicles() {
            vehicles.forEach(vehicle => {
                const route = vehicle.userData.route;
                const index = vehicle.userData.routeIndex;
                const target = route[index];

                if (target) {
                    const dx = target.x - vehicle.position.x;
                    const dz = target.z - vehicle.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);

                    if (distance < 0.5) {
                        vehicle.userData.routeIndex = (index + 1) % route.length;
                    } else {
                        const speed = vehicle.userData.speed;
                        vehicle.position.x += (dx / distance) * speed;
                        vehicle.position.z += (dz / distance) * speed;

                        // Rotate vehicle to face movement direction
                        const angle = Math.atan2(dx, dz);
                        vehicle.rotation.y = angle;
                    }
                }
            });
        }

        function changeView(view) {
            currentView = view;
            
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Animate camera position
            const duration = 1000;
            const startPos = { x: camera.position.x, y: camera.position.y, z: camera.position.z };
            let endPos;

            if (view === 'top') {
                endPos = { x: 0, y: 50, z: 50 };
            } else if (view === 'angle') {
                endPos = { x: 40, y: 40, z: 40 };
            } else if (view === 'follow') {
                endPos = { x: 0, y: 15, z: 30 };
            }

            const startTime = Date.now();
            
            function animateCamera() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // Ease out cubic

                camera.position.x = startPos.x + (endPos.x - startPos.x) * eased;
                camera.position.y = startPos.y + (endPos.y - startPos.y) * eased;
                camera.position.z = startPos.z + (endPos.z - startPos.z) * eased;
                camera.lookAt(0, 0, 0);

                if (progress < 1) {
                    requestAnimationFrame(animateCamera);
                }
            }

            animateCamera();
        }

        function onWindowResize() {
            const canvas = document.getElementById('map-canvas');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            
            updateVehicles();
            
            // Follow mode - track first vehicle
            if (currentView === 'follow' && vehicles.length > 0) {
                const followTarget = vehicles[0];
                camera.position.x = followTarget.position.x;
                camera.position.z = followTarget.position.z + 20;
                camera.lookAt(followTarget.position.x, 0, followTarget.position.z);
            }

            renderer.render(scene, camera);
        }

        // ============================================
        // APPLICATION LOGIC
        // ============================================

        let selectedRoute = null;

        function findRoute() {
            const from = document.getElementById('from-input').value;
            const to = document.getElementById('to-input').value;
            const vehicleType = document.getElementById('vehicle-select').value;

            if (!from || !to) {
                alert('Please enter both origin and destination');
                return;
            }

            // Show loading
            showLoading('Analyzing routes with AI agents...');

            // Simulate agent processing
            setTimeout(() => {
                updateAgentStatus('traffic', 'processing', 'Analyzing traffic patterns...');
            }, 500);

            setTimeout(() => {
                updateAgentStatus('traffic', 'active', 'Traffic analysis complete - Moderate congestion detected');
            }, 1500);

            setTimeout(() => {
                updateAgentStatus('tagalog', 'processing', 'Generating Tagalog explanation...');
            }, 2000);

            setTimeout(() => {
                updateAgentStatus('tagalog', 'active', 'Paliwanag: May kaunting traffic sa rutang ito dahil sa rush hour');
            }, 3000);

            setTimeout(() => {
                updateAgentStatus('optimizer', 'processing', 'Finding optimal routes...');
            }, 3500);

            setTimeout(() => {
                updateAgentStatus('optimizer', 'active', 'Found 3 optimal routes with real-time data');
                generateRoutes(from, to, vehicleType);
                updateTrafficInfo();
                hideLoading();
            }, 4500);
        }

        function updateAgentStatus(agent, status, message) {
            const agents = document.querySelectorAll('.agent-card');
            const agentMap = { 'traffic': 0, 'tagalog': 1, 'optimizer': 2 };
            const agentCard = agents[agentMap[agent]];
            
            if (agentCard) {
                const statusBadge = agentCard.querySelector('.agent-status');
                const content = agentCard.querySelector('.agent-content');
                
                statusBadge.className = `agent-status ${status}`;
                statusBadge.textContent = status === 'processing' ? 'Processing' : status === 'active' ? 'Complete' : 'Ready';
                content.textContent = message;
            }
        }

        function generateRoutes(from, to, vehicleType) {
            const routes = [
                {
                    type: 'Jeepney + Tricycle',
                    time: '45 min',
                    fare: '‚Ç±35',
                    steps: 'Jeep to Maharlika Highway ‚Üí Tricycle to destination',
                    traffic: 'moderate',
                    reliability: 'high'
                },
                {
                    type: 'UV Express (Direct)',
                    time: '30 min',
                    fare: '‚Ç±60',
                    steps: 'Direct route via new bypass road',
                    traffic: 'light',
                    reliability: 'very high'
                },
                {
                    type: 'Bus + Walk',
                    time: '55 min',
                    fare: '‚Ç±28',
                    steps: 'Bus to town proper ‚Üí 10min walk',
                    traffic: 'heavy',
                    reliability: 'medium'
                }
            ];

            const routeContainer = document.getElementById('route-options');
            routeContainer.innerHTML = '';

            routes.forEach((route, index) => {
                const routeCard = document.createElement('div');
                routeCard.className = 'route-card';
                routeCard.onclick = () => selectRoute(index, routeCard);
                
                routeCard.innerHTML = `
                    <div class="route-header">
                        <span class="route-type">${route.type}</span>
                        <span class="route-time">‚è±Ô∏è ${route.time}</span>
                    </div>
                    <div class="route-details">
                        <div style="margin-bottom: 5px;"><strong>Fare:</strong> ${route.fare}</div>
                        <div style="margin-bottom: 5px;"><strong>Route:</strong> ${route.steps}</div>
                        <div><strong>Traffic:</strong> <span style="color: ${route.traffic === 'light' ? '#10b981' : route.traffic === 'moderate' ? '#f59e0b' : '#ef4444'}">${route.traffic}</span></div>
                    </div>
                `;
                
                routeContainer.appendChild(routeCard);
            });
        }

        function selectRoute(index, element) {
            // Remove previous selection
            document.querySelectorAll('.route-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to clicked card
            element.classList.add('selected');
            selectedRoute = index;

            // Enable booking section
            const bookingSection = document.getElementById('booking-section');
            bookingSection.style.opacity = '1';
            bookingSection.style.pointerEvents = 'auto';
            bookingSection.querySelector('p').textContent = 'Route selected! Ready to book.';
        }

        function updateTrafficInfo() {
            const trafficLevels = [
                { level: 'Light', percentage: 25, explanation: 'Mabilis ang daloy ng trapiko. Walang delay, smooth sailing!' },
                { level: 'Moderate', percentage: 45, explanation: 'Katamtaman ang daloy ng trapiko. May ilang bottleneck sa may palengke pero generally smooth ang travel.' },
                { level: 'Heavy', percentage: 75, explanation: 'Mabigat ang trapiko ngayon. Maraming sasakyan at may mga construction sa daan. Mag-budget ng extra 15-20 minutes.' }
            ];

            const randomLevel = trafficLevels[Math.floor(Math.random() * trafficLevels.length)];

            document.getElementById('traffic-level-text').textContent = randomLevel.level;
            document.getElementById('traffic-bar-fill').style.width = randomLevel.percentage + '%';
            document.getElementById('traffic-explanation').innerHTML = `<strong>Paliwanag:</strong> ${randomLevel.explanation}`;
        }

        function bookTrip() {
            if (selectedRoute === null) {
                alert('Please select a route first');
                return;
            }

            showLoading('Booking your UV Express seat...');

            setTimeout(() => {
                hideLoading();
                alert('üé´ Booking Confirmed!\n\nUV Express - Seat 3A\nDeparture: 3:30 PM\nPickup: Cabanatuan Terminal\n\nBooking Reference: SA-' + Math.random().toString(36).substr(2, 9).toUpperCase());
            }, 2000);
        }

        function payGCash() {
            if (selectedRoute === null) {
                alert('Please select a route first');
                return;
            }

            showLoading('Connecting to GCash payment gateway...');

            setTimeout(() => {
                hideLoading();
                alert('üí≥ Payment Successful!\n\n‚Ç±60.00 paid via GCash\nTransaction ID: GC' + Math.random().toString(36).substr(2, 12).toUpperCase() + '\n\nReceipt sent to your mobile number.');
            }, 2500);
        }

        function showLoading(text) {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = text;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('active');
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        window.addEventListener('load', () => {
            initThreeJS();
            
            // Simulate real-time updates
            setInterval(() => {
                if (Math.random() > 0.7) {
                    updateTrafficInfo();
                }
            }, 15000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            // Dispose Three.js resources
            vehicles.forEach(vehicle => {
                vehicle.traverse(child => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(mat => mat.dispose());
                        } else {
                            child.material.dispose();
                        }
                    }
                });
            });

            scene.traverse(object => {
                if (object.geometry) object.geometry.dispose();
                if (object.material) {
                    if (Array.isArray(object.material)) {
                        object.material.forEach(mat => mat.dispose());
                    } else {
                        object.material.dispose();
                    }
                }
            });

            renderer.dispose();
        });
    </script>
</body>
</html>